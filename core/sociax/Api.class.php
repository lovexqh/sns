<?php// +----------------------------------------------------------------------// | OpenSociax [ open your team ! ]// +----------------------------------------------------------------------// | Copyright (c) 2010 http://www.sociax.com.cn All rights reserved.// +----------------------------------------------------------------------// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )// +----------------------------------------------------------------------// | Author: genixsoft.net <智士软件>// +----------------------------------------------------------------------// $Id$/** +------------------------------------------------------------------------------ * API接口抽象类 +------------------------------------------------------------------------------ * @category	core * @package		core * @author		lengharoan <lenghaoran@thinksns.com> * @version		$0.1$ +------------------------------------------------------------------------------ */abstract class Api extends Think {	var $mid; //当前登录的用户ID	var $since_id;	var $max_id;	var $page;	var $count;	var $user_id;	var $user_name;	var $id;	var $data;    public $db_prefix;    protected $apiConfig;	private $_module_white_list = null; // 白名单模块    public function __construct()    {//        $this->verifyMobile() || exit('<h1>遇到错误了!!</h1>');        $this->db_prefix = C('DB_PREFIX');        $this->_module_white_list = array('Oauth','VerMange','CheckVer');//        测试        if($_REQUEST['l'] == 1){            $location = 1;        }//        $location = false;    	if ($location == false) {			if (!$this->mid && !in_array(MODULE_NAME, $this->_module_white_list))				$this->verifyUser();    	} else {    		$this->mid = $_SESSION['mid'];		}		$this->data       = $_REQUEST;		$this->since_id   = $_REQUEST['since_id']   ? intval( $_REQUEST['since_id'] ) : '';		$this->max_id     = $_REQUEST['max_id']     ? intval( $_REQUEST['max_id'] )   : '';		$this->page       = $_REQUEST['page']       ? intval( $_REQUEST['page'] )     : 1;		$this->count      = $_REQUEST['count']      ? intval( $_REQUEST['count'] )    : 20;		$this->user_id    = $_REQUEST['user_id']    ? intval( $_REQUEST['user_id'])   : 0;		$this->user_name  = $_REQUEST['user_name']  ? h( $_REQUEST['user_name'])      : '';		$this->id         = $_REQUEST['id']         ? intval( $_REQUEST['id'])        : 0;        //定义常量        if(!defined('RUNTIME_DIR'))		define('RUNTIME_DIR',SITE_PATH.'/_runtime');        if(!defined('MOBILE_CACHE_DIR'))		define('MOBILE_CACHE_DIR',RUNTIME_DIR.'/~mobileViews');        //引入自定义函数库        $this->apiConfig = include_once SITE_PATH . '/api/mobileApi/api.config.php';        include_once SITE_PATH . '/api/mobileApi/api.fun.php';    	//控制器初始化        if(method_exists($this,'_initialize'))            $this->_initialize();    }    /**     *+---------------------------------------------------     *verifyMobile—验证是否是手机请求     *+---------------------------------------------------     * @return bool     * @author  徐程亮     *+---------------------------------------------------     *创建时间：     *+----------------------------------------------------     */    private function verifyMobile(){        $useragent  = strtolower($_SERVER["HTTP_USER_AGENT"]);        $iphone  = strripos($useragent,'iphone');        $android    = strripos($useragent,'android');        if($android === false){            $android    = strripos($useragent,'java');        }        if($iphone!==false || $android!==false){            return true;        }else{            return false;        }    }    //认证用户    private function verifyUser(){    	$verifycode['oauth_token'] = h($_REQUEST['oauth_token']);    	$verifycode['oauth_token_secret'] = h($_REQUEST['oauth_token_secret']);//    	$verifycode['type'] = 'location';    	if($login = M('login')->where($verifycode)->field('uid,oauth_token,oauth_token_secret')->find() ){    		$this->mid = $login['uid'];    		$_SESSION['mid'] = $this->mid;    	}else{    		$this->verifyError();    	}    }    //第一次认证成功，生成token和token_sectrect    private function buildToken($uid){    }    //认证失败	protected  function verifyError(){		$message['message'] = '认证失败';		$message['code']    = '00001';        exit( json_encode( $message ) );//        if($_REQUEST['format'] == 'html'){//            exit( '<script>window.location="objc://error^login"</script>' );//        }else{//            exit( json_encode( $message ) );//        }	}    public function data($data){        if(is_object($data)){            $data   =   get_object_vars($data);        }		$this->since_id   = $data['since_id']   ? intval( $data['since_id'] ) : '';		$this->max_id     = $data['max_id']     ? intval( $data['max_id'] )   : '';		$this->page       = $data['page']       ? intval( $data['page'] )     : 1;		$this->count      = $data['count']      ? intval( $data['count'] )    : 20;		$this->user_id    = $data['user_id']    ? intval( $data['user_id'])   : $this->mid;		$this->user_name  = $data['user_name']  ? h( $data['user_name'])      : '';		$this->id         = $data['id']         ? intval( $data['id'])        : 0;        $this->data = $data;        return $this;    }    /**     *+---------------------------------------------------     *render——自定义模版渲染     *+---------------------------------------------------     * @param bool $layout default=true 默认使用全局文件#注意：文件名全小写     * @param string $view  默认渲染当前方法     * @param string $main  默认应用默认全局文件     * @author  徐程亮     *+---------------------------------------------------     *创建时间：13-7-9 上午8:34     *+----------------------------------------------------     */    protected function render($arr=array(),$layout=true,$main='',$view='',$css=array()){        //分配变量        foreach ($arr as $k=>$v) {            $$k = $v;        }        $_REQUEST['format']= 'html';       //类库文件路径       if(!defined('API_LIB_PATH'))		define('API_LIB_PATH',SITE_URL.'/'.APP_NAME.'/mobileViews/lib/');       //公共文件路径       if(!defined('API_PUBLIC_PATH'))		define('API_PUBLIC_PATH',SITE_URL.'/'.APP_NAME.'/mobileViews/public/');        //CSS文件路径        if(!$css){            $css[]=API_PUBLIC_PATH.'css/'.strtolower(MODULE_NAME.'-'.ACTION_NAME);        }else{            foreach($css as $k=>$v){                $css[$k] = API_PUBLIC_PATH.'css/'.$v.'.css';            }        }       $action_name = strtolower(ACTION_NAME);       $module_name = strtolower(MODULE_NAME);       if(!$view){           $view_path = SITE_PATH.'/'.APP_NAME.'/mobileViews/'.$module_name.'/'.$action_name.'.htm.php';       }else{           if(strpos($view,'/') ===false){               $view_path = SITE_PATH.'/'.APP_NAME.'/mobileViews/'.$module_name.'/'.$view.'.htm.php';           }else{               $view_path = SITE_PATH.'/'.APP_NAME.'/mobileViews/'.$view.'.htm.php';           }       }       if($main){           $layout_path = SITE_PATH.'/'.APP_NAME.'/mobileViews/layout/'.$main.'.htm.php';       }else{           $layout_path = SITE_PATH.'/'.APP_NAME.'/mobileViews/layout/main.htm.php';       }       if($layout){           include_once $layout_path;       }else{           include_once $view_path;       }   }}?>