<?phpclass OauthApi extends Api{    function access_token(){        if($_POST['userId'] && $_POST['passwd']){            $username = desdecrypt($_POST['userId'],'12345678');            if( is_numeric($username) ){                $map['uid'] = $username;            }elseif (is_string($username)){                $map['email'] = h($username);            }else{                return;            }            $map['password'] = md5(desdecrypt( h($_REQUEST['passwd']) ,'12345678' ) );            $user = M('user')->where($map)->field('uid')->find();            $this->mid = $user['uid'];        }    }    /**    +------------------------------------------------------------------------------     * DES加密某个字符串     * author：sunxiaobo     * date：2012-11-23    +------------------------------------------------------------------------------     */    function descode(){        if($_REQUEST['key'])            return desencrypt($_REQUEST['key'],$this->getRequestKey());    }    function request_key(){        return array($this->getRequestKey());    }    /**     * 获取所有应用列表     */    public function get_apps(){        return M('app')->findAll();    }    private function getRequestKey(){        return "thinksns";    }    function authorize(){        if($_POST['uid'] && $_POST['passwd']){            // 杨德升添加            $isIphone = $_REQUEST['isIphone']==='1';            $username = $isIphone ? $_POST['uid'] : desdecrypt( $_POST['uid'],$this->getRequestKey());            if( is_numeric($username) ){                $map['uid'] = $username;            }elseif (is_string($username)){                $map['email'] = $username;            }else{                $this->verifyError();            }            $map['password'] = $isIphone ? md5($_POST['passwd']) : md5( desdecrypt($_POST['passwd'],$this->getRequestKey()) );            $user = M('user')->where($map)->field('uid,uname')->find();            if($user){                if( $login = M('login')->where("uid=".$user['uid']." AND type='location'")->find() ){                    $data['oauth_token']         = $login['oauth_token'];                    $data['oauth_token_secret']  = $login['oauth_token_secret'];                    $data['uid']                 = $user['uid'];                    $data['name']  = $user['uname'];                    if(UC_SYNC){                        $uc_id = M('ucenter_user_link')->where('uid='.$user['uid'])->field('uc_uid')->find();                        $param = array();                        $param['uid'] = "{$uc_id['uc_uid']}";                        $userInfo = get_webService('Uuse004',$param);                        $data ['role'] = $userInfo[0]['identitytype'];                        $data ['identityid'] = $userInfo[0]['identityid'];                        $data ['schoolid'] = $userInfo[0]['schoolid'];                        $data['uc_id'] = $uc_id['uc_uid'];                        if($data['role'] ==3){                            $data['classid'] = $userInfo[0]['classid'];                            $jb = get_webService('Usch021',array('classid'=>(string)$data['classid']));                            $data['jbid'] = $jb[0]['id'];                        }                    }                }else{                    $data['oauth_token']         = getOAuthToken($user['uid']);                    $data['oauth_token_secret']  = getOAuthTokenSecret();                    $data['uid']                 = $user['uid'];                    $savedata['type']            = 'location';                    $savedata = array_merge($savedata,$data);                    if(UC_SYNC){                        $uc_id = M('ucenter_user_link')->where('uid='.$user['uid'])->field('uc_uid')->find();                        $param = array();                        $param['uid'] = "{$uc_id['uc_uid']}";                        $userInfo = get_webService('Uuse004',$param);                        $data ['role'] = $userInfo[0]['identitytype'];                        $data ['identityid'] = $userInfo[0]['identityid'];                        $data ['schoolid'] = $userInfo[0]['schoolid'];                        $data['uc_id'] = $uc_id['uc_uid'];                        if($data['role'] ==3){                            $data['classid'] = $userInfo[0]['classid'];                            $jb = get_webService('Usch021',array('classid'=>(string)$data['classid']));                            $data['jbid'] = $jb[0]['id'];                        }                    }                    M('login')->add($savedata);                }                return $data;            }else{                $this->verifyError();            }        }else{            $this->verifyError();        }    }}